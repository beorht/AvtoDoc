###  Тема урока
#### Тема № 20: Случайные значения, Криптографические генераторы псевдослучайных чисел и Сборщики энтропии: Основы безопасной случайности

Основные разделы образовательного материала:
1.  **Понятие случайности и её роль в криптографии:** Истинная случайность против псевдослучайности.
2.  **Криптографические генераторы псевдослучайных чисел (CSPRNG):** Принципы работы, свойства и отличия от обычных PRNG.
3.  **Источники и сборщики энтропии:** Что такое энтропия в контексте случайных чисел, её источники и механизмы сбора.
4.  **Взаимодействие CSPRNG и энтропии. Практические аспекты:** Посев (seeding), пополнение (reseeding), проблемы низкой энтропии и популярные решения.

Текст образовательного материала:

Добро пожаловать на лекцию, посвященную одной из фундаментальных и, возможно, наименее интуитивно понятных концепций в области информационной безопасности и криптографии – случайным значениям. Мы рассмотрим, почему они так важны, как их генерировать безопасно и что такое энтропия.

 

### 1. Понятие случайности и её роль в криптографии

В повседневной жизни мы часто говорим о случайности: бросок монеты, результат лотереи, погода. Однако в контексте криптографии "случайность" приобретает гораздо более строгое определение.

**Истинная случайность** (True Randomness) — это последовательность чисел, которую невозможно предсказать или воспроизвести, даже имея полную информацию о предыдущих числах в последовательности или о методе их генерации. Она должна быть статистически равномерной (каждое значение имеет равную вероятность появления) и независимой (появление одного значения не влияет на появление другого).

**Почему истинная случайность так важна в криптографии?**
Криптография полагается на случайность для обеспечения безопасности многих своих компонентов:
*   **Генерация ключей:** Шифровальные ключи, ключи подписи, ключи симметричных и асимметричных алгоритмов должны быть совершенно случайными, чтобы злоумышленник не мог их угадать или предсказать. Если ключ предсказуем, вся защита рушится.
*   **Нонсы (Nonces):** Числа, используемые "только один раз", например, для предотвращения атак повторного воспроизведения (replay attacks) или в процессе аутентификации.
*   **Соли (Salts):** Случайные данные, добавляемые к паролям перед хешированием, чтобы защититься от атак по радужным таблицам.
*   **Инициализирующие векторы (IVs):** Случайные значения, используемые в режимах работы блочных шифров для обеспечения уникальности каждого шифрования.

Проблема в том, что получить *истинно* случайные числа с помощью детерминированного компьютера чрезвычайно сложно, если вообще возможно. Компьютеры следуют инструкциям, и любая последовательность, генерируемая по алгоритму, по определению является предсказуемой. Здесь на сцену выходят **псевдослучайные числа**.

 

### 2. Криптографические генераторы псевдослучайных чисел (CSPRNG)

**Криптографический генератор псевдослучайных чисел (CSPRNG)** (Cryptographically Secure Pseudorandom Number Generator) – это алгоритм, который генерирует последовательность чисел, *выглядящую* случайной, но на самом деле детерминированной. Ключевое слово здесь – "криптографический". Это означает, что он обладает определенными свойствами, критически важными для безопасности:

*   **Непредсказуемость:** Даже если злоумышленник знает все предыдущие выходные данные CSPRNG, он не может предсказать следующие. Также невозможно предсказать предыдущие значения, имея только текущие. Это свойство называется **стойкостью к ретроспективному и перспективному анализу** (backward and forward secrecy).
*   **Невозможность восстановления состояния:** Злоумышленник не должен иметь возможности восстановить внутреннее состояние генератора, даже имея часть его выходных данных.
*   **Статистическая случайность:** Выходные данные должны проходить все статистические тесты на случайность (равномерность распределения, отсутствие корреляций и т.д.).

**Принцип работы:**
CSPRNG начинается с **посева (seed)** – начального случайного значения, которое является единственным по-настоящему случайным компонентом в его работе. Затем, используя это зерно, CSPRNG переходит из одного внутреннего состояния в другое, генерируя на каждом шаге выходные данные. Каждое новое состояние зависит от предыдущего и от специальных математических функций, часто основанных на криптографических примитивах, таких как хеш-функции или блочные шифры.

**Отличия от обычных PRNG (Pseudorandom Number Generator):**
Обычные PRNG (например, функция `rand()` в C или `Math.random()` в JavaScript, если не указано иное) также генерируют псевдослучайные числа. Однако их основная цель – статистическая случайность для симуляций или игр. Они *не* предназначены для криптографии, потому что:
*   Их внутреннее состояние часто легко восстановить по нескольким выходным значениям.
*   Они могут быть предсказуемы.
*   Они не используют высококачественную энтропию для посева.

**Примеры CSPRNG:**
*   **Операционные системы:** Большинство современных ОС имеют встроенные CSPRNG. В Linux это `/dev/urandom` и `/dev/random`, в Windows – функция `CryptGenRandom`.
*   **Алгоритмы:** Fortuna, Yarrow, AES-CTR DRBG, Hash_DRBG.

 

### 3. Источники и сборщики энтропии

CSPRNGs являются детерминированными и, следовательно, не являются *истинно* случайными. Чтобы быть криптографически стойкими, им нужна периодическая подпитка *истинной* случайностью, чтобы злоумышленник не мог предсказать их внутреннее состояние. Эта "истинная случайность" называется **энтропией**.

**Что такое энтропия в контексте случайных чисел?**
Энтропия (от греч. `εντροπία` – поворот, превращение) в физике и теории информации – это мера беспорядка, непредсказуемости или неопределенности системы. Чем выше энтропия, тем менее предсказуемо событие или значение. Для CSPRNG нам нужна *высококачественная* энтропия, то есть данные, которые трудно предсказать.

**Источники энтропии:**
Компьютеры и окружающая среда генерируют множество непредсказуемых событий, которые могут служить источниками энтропии:
*   **Движения пользователя:** Случайные (для компьютера) движения мыши, нажатия клавиш, тайминги между нажатиями.
*   **Ввод/вывод:** Задержки при чтении/записи с диска, сетевой трафик (тайминги прихода пакетов, содержимое пакетов).
*   **Аппаратные события:** Измерения температуры процессора, скорости вращения вентиляторов, колебания напряжения, тайминги прерываний.
*   **Процессорные шумы:** Небольшие, непредсказуемые колебания в работе CPU, jitter (дрожание) таймеров.
*   **Аппаратные генераторы случайных чисел (HRNGs / TRNGs):** Специализированные физические устройства, использующие аналоговые источники шума (например, тепловой шум резисторов, квантовые явления) для генерации истинно случайных битов. Считаются лучшими источниками энтропии.

**Сборщики энтропии:**
Операционные системы имеют специальные компоненты – **сборщики энтропии (entropy collectors)**, которые непрерывно мониторят эти непредсказуемые события. Они собирают "сырые" данные из различных источников, очищают их от очевидных смещений (bias), хешируют и объединяют в специальный **пул энтропии (entropy pool)**. Этот пул служит буфером для накопленной энтропии, готовой к использованию CSPRNG.

 

### 4. Взаимодействие CSPRNG и энтропии. Практические аспекты

Связь между CSPRNG и сборщиками энтропии жизненно важна:
*   **Посев (Seeding):** CSPRNG *обязательно* должен быть инициализирован (посеян) достаточным количеством высококачественной энтропии. Без хорошего посева, даже самый лучший CSPRNG будет генерировать предсказуемые последовательности.
*   **Пополнение (Reseeding):** Со временем, если CSPRNG работает долго, или если его состояние могло быть скомпрометировано, ему необходимо "доливать" новую энтропию из пула. Это повышает стойкость к атакам и обеспечивает постоянную непредсказуемость.

**Проблемы низкой энтропии:**
Низкая энтропия – серьезная проблема безопасности, особенно в некоторых сценариях:
*   **Встраиваемые системы (Embedded systems):** Устройства без клавиатуры, мыши или диска могут иметь мало источников энтропии.
*   **Виртуальные машины (VMs):** Несколько VM, запущенных на одном хосте, могут иметь очень похожие источники энтропии, особенно если они запущены одновременно и не имеют доступа к аппаратным источникам.
*   **Первый запуск системы (First boot):** Сразу после установки ОС или первого запуска устройства, еще нет активности пользователя или достаточного сетевого трафика для накопления энтропии.

**Последствия низкой энтропии:**
Если CSPRNG не имеет достаточного количества энтропии для посева, он может:
*   **Генерировать предсказуемые ключи:** Что делает всю криптографию бесполезной. Были реальные случаи, когда из-за низкой энтропии на серверах генерировались одинаковые или предсказуемые SSH-ключи, TLS-сертификаты.
*   **Приостанавливать работу:** Некоторые CSPRNG (как `/dev/random` в Linux) могут блокироваться и ждать, пока накопится достаточно энтропии. Это может привести к зависанию приложений, ожидающих случайных чисел.

**Популярные решения и инструменты:**
*   **`/dev/random` vs. `/dev/urandom` (Linux):**
    *   **`/dev/random`**: Считается более "параноидальным". Он использует только "качественные" биты энтропии из пула и *блокируется*, если в пуле недостаточно энтропии, ожидая её накопления. Используется для генерации долгоживущих криптографических ключей, таких как SSH-ключи или ключи GPG.
    *   **`/dev/urandom`**: Использует CSPRNG, который посеян энтропией из пула. Он *не блокируется*, даже если пул энтропии пуст. Вместо этого он продолжает генерировать псевдослучайные числа на основе своего текущего состояния. Современные криптографические исследования показывают, что после первичного качественного посева, `/dev/urandom` предоставляет достаточно надежные случайные числа для большинства криптографических нужд, и в большинстве случаев предпочтительнее `/dev/random` из-за того, что он не блокирует работу приложений.
*   **`rngd` (Random Number Generator Daemon):** Демон, который собирает энтропию из аппаратных источников (например, `/dev/hwrng`) и подает её в системный пул энтропии.
*   **Аппаратные генераторы случайных чисел (HRNGs):** Все чаще интегрируются в чипы (например, Intel RDRAND, ARM TrustZone), обеспечивая высококачественную энтропию напрямую.

 

**Выводы и рекомендации:**

1.  **Случайность – это не опция, а необходимость** для обеспечения безопасности в криптографии. Без качественных случайных чисел, любая криптографическая защита будет скомпрометирована.
2.  **Истинная случайность труднодостижима на детерминированных системах.** Поэтому мы используем **CSPRNG**, которые генерируют последовательности, *неотличимые* от случайных и *непредсказуемые*.
3.  **CSPRNG абсолютно зависят от высококачественной энтропии** для своего начального посева и периодического пополнения. Без хороших источников энтропии, даже самый стойкий CSPRNG будет бесполезен.
4.  **Всегда используйте системные CSPRNG** (например, `/dev/urandom` на Unix-подобных системах, `CryptGenRandom` на Windows) для генерации криптографически стойких случайных чисел. Никогда не реализуйте собственные генераторы и не используйте обычные PRNG для задач безопасности.
5.  **Будьте внимательны к проблеме низкой энтропии,** особенно при развертывании систем в виртуализированных средах или на встраиваемых устройствах. Рассмотрите использование аппаратных RNG или специализированных демонов для сбора энтропии.

Понимание и правильное использование случайности являются краеугольным камнем современной информационной безопасности.